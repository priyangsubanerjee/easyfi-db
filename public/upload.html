<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.26.1/axios.js" integrity="sha512-MNW6IbpNuZZ2VH9ngFhzh6cUt8L/0rSVa60F8L22K1H72ro4Ki3M/816eSDLnhICu7vwH/+/yb8oB3BtBLhMsA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body >
    <div class="px-6 py-4 border-b">
        <h1 class="text-2xl font-semibold">EasyFi DB</h1>
        <p class="text-gray-500 mt-1 text-sm">Free file hosting solution.</p>
    </div>
    <br>
    <div id="upload-box" class="py-20 border-dashed border-[2px] flex flex-col items-center justify-center my-16 mx-16 cursor-pointer rounded hover:border-gray-400 transition-all">
        <img class="h-28 w-32" src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/27/Noun_Project_cloud_upload_icon_411593_cc.svg/1130px-Noun_Project_cloud_upload_icon_411593_cc.svg.png" alt="">
        <p class="text-gray-400 mt-6">Click here to upload files.</p>
        <input hidden type="file" name="" id="file-upload">
    </div>
    <div class="mx-8">
        <p class="text-center leading-7 text-gray-500">
            It is a simple and easy to use image hosting service that supports all image formats. None the less we also support video formats & Pdf's too.
        </p>
        <button hidden class="px-4 py-3 mt-6 text-sm bg-black text-white rounded hover:shadow-2xl hover:translate-y-1 transition-all">
            <img class="w-6 h-6 inline-block rounded-full mr-2" src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="">
            View Source Code
        </button>
        <hr class="mt-8">
        <div class="mt-20">
            <h1 class="text-3xl border-dashed border-b-2 pb-2 w-fit font-medium">Previous uploads</h1>
            <div id="previous-uploads" class="mb-16">

            </div>
        </div>
    </div>
    <div style="display: none;" class="fixed top-0 left-0 w-full h-full z-20 bg-[#00000080] flex items-center justify-center" id="uploading-layer">
        <div class="min-h-[600px] w-[530px] bg-white rounded overflow-hidden w-full">
            <div id="uploading-container" style="display: none;">
                <img src="https://cdn.dribbble.com/users/4908/screenshots/2570659/rocket.gif" class="w-full" alt="">
                <div>
                    <h1 class="mt-12 font-semibold text-black text-2xl text-center">Uploading File</h1>
                    <p class="text-center text-gray-500 text-sm mt-4">
                        Please wait while we upload your file.
                    </p>
                    <p class="text-center text-blue-500 text-sm mt-6 cursor-pointer">Terms &amp; Conditions</p>
                </div>
                
            </div>
            <div id="uploaded-container" style="display: block;">
                <img src="https://icons.veryicon.com/png/o/miscellaneous/cloud-call-center/success-24.png" class="w-24 mx-auto mt-24" alt="">
                <div>
                    <h1 class="mt-12 font-semibold text-black text-2xl text-center">File uploaded successfully.</h1>
                    <p class="text-center text-gray-500 text-sm mt-4 px-10 leading-6">
                        File has been uploaded successfully. You can view your file by clicking on the link below.
                    </p>
                    <a target="_blank" class="mx-auto mt-6 block w-fit text-sm text-blue-500" href="" id="uploaded-file-anchor">View file</a>
                    <div class="w-full flex mt-12">
                        <button class="border border-black text-black px-4 py-2 rounded text-sm mx-auto hover:bg-black hover:text-white hover:shadow-2xl transition-all" id="upload-another">Close</button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    <script>

        // Initialize

        window.onload = function() {
            updatePreviousUploads()
        };

        const uploadBox = document.getElementById('upload-box');
        const fileUpload = document.getElementById('file-upload');
        const uploadingLayer = document.getElementById('uploading-layer');
        const uploadingContainer = document.getElementById('uploading-container');
        const uploadedContainer = document.getElementById('uploaded-container');
        const uploadedFileAnchor = document.getElementById('uploaded-file-anchor');
        const uploadAnother = document.getElementById('upload-another');
        const previous_uploads = document.getElementById('previous-uploads');
        const file_location = document.getElementById('file-location');

        let uploaded_filename;
        let uploaded_file_link;


        // Events

        uploadBox.addEventListener('click', () => {
            document.getElementById('file-upload').click();
        });

        fileUpload.addEventListener('change', function(e) {

            // Show uploading layer
            uploadingLayer.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            uploadedContainer.style.display = 'none';
            uploadingContainer.style.display = 'block';

            // Get file
            var file = e.target.files[0];
            uploaded_filename = file.name;

            var formData = new FormData();
            formData.append('userImage', file);
            axios.post('/upload-image', formData).then(async function(response) {
                
                uploadedContainer.style.display = 'block';
                uploadingContainer.style.display = 'none';
                uploadedFileAnchor.href = response.data.imageUrl;
                uploadedFileAnchor.innerText = file.name;

                saveUpload(file.name, response.data.imageUrl);

                try {
                    file_location.href = response.data.imageUrl;
                    file_location.innerHTML = response.data.imageUrl;   
                } catch (error) {
                    console.log(error);
                }
            
            })
        });
   
        uploadAnother.addEventListener('click', () => {
            uploadingLayer.style.display = 'none';
            document.body.style.overflow = 'auto';
            uploadedContainer.style.display = 'none';
            uploadingContainer.style.display = 'block';
        });


        previous_uploads.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-file')) {
                let file_url = e.target.getAttribute('data-id');
                if(confirm("Are you sure you want to delete this file?")) {
                   deleteFile(file_url);
                }
            }
        });


        async function saveUpload (name, url){

            const dateNow = new Date().toLocaleString();
            const file = new File(name, url, dateNow);
            const files = await localStorage.getItem('files');
            let filesArray = files ? JSON.parse(files) : [];
            filesArray.push(file);
            localStorage.setItem('files', JSON.stringify(filesArray));
            updatePreviousUploads()
        }



        async function updatePreviousUploads(){

            const files = await localStorage.getItem('files') || [];
            const filesArray = files.length > 0 ? JSON.parse(files) || [] : [];
            previous_uploads.innerHTML = '';
            filesArray.reverse().forEach(file => {
                
                const currentFile = new File(file.name, file.url, file.date);
                const template = getFileTemplate(currentFile);
                previous_uploads.innerHTML += template;
            });
        }


        function getFileTemplate(file){

            const template = `
            <div class="mt-6 p-4 border">
                <span class="text-gray-500 text-base">${file.getFileName()}</span>
                <span class="text-gray-500 text-xs ml-2">(${file.getFileDate()})</span><br/>
                <a target="_blank" class="text-sm text-blue-500 mt-1" href=${file.url}>${file.url}</a><br/>
                <button data-id="${file.getFileUrl()}" class="delete-file mt-2 bg-gray-200 text-black text-sm px-2">Delete</button>
            </div>`

            return template;
        }

        function deleteFile(url){

            const fileUrl = url;
            const fileName = url.split('/')[url.split('/').length - 1];

            axios.post('/delete', JSON.stringify({name : fileName}), {
                headers: {
                    'Content-Type': 'application/json'
                }
            })

            const files = localStorage.getItem('files');
            const filesArray = JSON.parse(files) || [];
            const index = filesArray.findIndex(file => file.url === fileUrl);
            filesArray.splice(index, 1);
            localStorage.setItem('files', JSON.stringify(filesArray));
            updatePreviousUploads();
        }


        class File{

            constructor(name, url, date){
                this.name = name;
                this.url = url;
                this.date = date;
            }

            getFileName(){
                return this.name;
            }

            getFileUrl(){
                return this.url;
            }

            getFileDate(){
                return this.date;
            }
        }


   </script>
</body>
</html>